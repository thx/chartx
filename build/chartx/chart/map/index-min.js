define("chartx/chart/map/index",["canvax/index","chartx/chart/index","canvax/shape/Path","canvax/shape/Polygon","chartx/chart/map/map-data/params","chartx/chart/map/map-data/geo-coord","chartx/chart/map/map-data/text-fixed","chartx/utils/projection/normal","chartx/components/tips/tip","chartx/utils/dataformat","chartx/components/markpoint/index"],function(a,b,c,d,e,f,g,h,i,j,k){return b.extend({init:function(b,c,d){this._opts=d,this.mapName="china",this._mapDataMap={},this.tips={},this.normalColor="#c9bbe6",this.area={strokeStyle:"white",fillStyle:this.normalColor,lineWidth:1,linkage:!1,text:{fillStyle:"#000",enabled:!0}},this.geoCoordSupply={},this.areaField="area",this.tips={field:[]},_.deepExtend(this,d),this._initData(c),this.tips.field=this.dataFrame.yAxis.field,this._mapScale=1,this.sprite=new a.Display.Sprite({id:"mapSp"}),this.spriteTip=new a.Display.Sprite({id:"tip"})},_initData:function(a){return this.dataFrame=j(a,{xAxis:{field:[this.areaField]},yAxis:{field:this.tips.field}}),this.dataFrame},draw:function(){this.sprite.removeAllChildren(),this.stage.addChild(this.sprite),this.stage.addChild(this.spriteTip),this._tips&&this._tips.hide(),this._initModule();var a=this;this._getMapData(this.mapName,function(b){a._widget(b),"markPoint"in a._opts&&a._initMarkPoint(),a._setSpPos()})},_setSpPos:function(){var a=this._mapDataMap[this.mapName].transform,b=this.sprite.context;b.width=a.width,b.height=a.height,b.x=(this.width-a.width)/2,b.y=(this.height-a.height)/2,b=this.spriteTip.context,b.width=a.width,b.height=a.height,b.x=(this.width-a.width)/2,b.y=(this.height-a.height)/2},_getMapData:function(a,b){this._mapDataMap[a]=this._mapDataMap[a]||{},e.params[a].getGeoJson(this._mapDataCallback(a,b))},_mapDataCallback:function(a,b){var c=this;return function(d){c._mapDataMap[a].mapData=d,c._mapDataMap[a].rate=.75,c._mapDataMap[a].projection=h;var e=c._getProjectionData(a,d);_.isFunction(b)&&b(e)}},_getProjectionData:function(a,b){var c,d=this._mapDataMap[a].projection,e=[],f=this._mapDataMap[a].bbox||d.getBbox(b),g=this._getTransform(f,this._mapDataMap[a].rate),h=this._mapDataMap[a].lastTransform||{scale:{}};g.left!=h.left||g.top!=h.top||g.scale.x!=h.scale.x||g.scale.y!=h.scale.y?(c=d.geoJson2Path(b,g),h=_.clone(g)):(g=this._mapDataMap[a].transform,c=this._mapDataMap[a].pathArray),this._mapDataMap[a].bbox=f,this._mapDataMap[a].transform=g,this._mapDataMap[a].lastTransform=h,this._mapDataMap[a].pathArray=c;for(var i=[g.left,g.top],j=0,k=c.length;k>j;j++)e.push(this._getSingleProvince(a,c[j],i));return e},parsePercent:function(a,b){return"string"==typeof a?_trim(a).match(/%$/)?parseFloat(a)/100*b:parseFloat(a):a},geo2pos:function(a,b){return this._mapDataMap[a].transform?this._mapDataMap[a].projection.geo2pos(this._mapDataMap[a].transform,b):null},_getSingleProvince:function(a,b,c){var d,e=b.properties.name,h=g[e]||[0,0];if(f[e])d=this.geo2pos(a,f[e]);else if(b.cp)d=[b.cp[0]+h[0],b.cp[1]+h[1]];else{var i=this._mapDataMap[a].bbox;d=this.geo2pos(a,[i.left+i.width/2,i.top+i.height/2]),d[0]+=h[0],d[1]+=h[1]}return b.name=e,b.position=c,b.textX=d[0],b.textY=d[1],b},_getTransform:function(a,b){var c,d,e=this.width,f=this.height;c=c?this.parsePercent(c,e):e,d=d?this.parsePercent(d,f):f;var g=a.width,h=a.height,i=c/b/g,j=d/h;return i>j?(i=j*b,c=g*i):(j=i,i=j*b,d=h*j),{left:0,top:0,width:c,height:d,baseScale:1,scale:{x:i,y:j}}},_createDataObj:function(a,b){var c={};return _.each(b,function(b,d){c[b]=a[d]}),c},_getDataForArea:function(a){var b={area:a},c=this;return _.each(this.dataFrame.xAxis.org[0],function(d,e){(d.indexOf(a.name)>=0||a.name.indexOf(d)>=0)&&(b.data=c._createDataObj(c.dataFrame.org[e+1],c.dataFrame.org[0]),b.dataIndex=e)}),b},_getColor:function(a,b,c){var d=a;return _.isFunction(a)&&(d=a.apply(this,[this._getDataForArea(b),this.dataFrame])),d&&""!=d||(d=arguments.length>=3?c:this.normalColor),d},_widget:function(b){var d,f=this,g=b,h=g.length;f.area.text.enabled&&(d=new a.Display.Sprite({id:"area_name"}));var i=new a.Display.Sprite({id:"areas"});_.each(g,function(b,g){var j={x:0,y:0,scaleX:f._mapScale,scaleY:f._mapScale,path:b.path,lineWidth:f.area.lineWidth,fillStyle:f._getColor(f.area.fillStyle,b),strokeStyle:f._getColor(f.area.strokeStyle,b),cursor:"pointer"},k=new c({hoverClone:!1,context:j});if(i.addChild(k),k.defInd=g,k.mapData=b,k.on("mouseover",function(a){this.toFront(),a.fromTarget&&"text"==a.fromTarget.type&&a.fromTarget.text==this.mapData.name||(f.fire("areaover",a),f._tips.show(f._setTipsInfoHand(a,this.mapData)))}),k.on("mousemove",function(a){f._tips.move(f._setTipsInfoHand(a,this.mapData))}),k.on("mouseout",function(a){this.toBack(h-this.defInd),a.toTarget&&"text"==a.toTarget.type&&a.toTarget.text==this.mapData.name||(f.fire("areaout",a),f._tips.hide(a))}),k.on("click",function(a){f.area.linkage&&("台湾"==f.mapName||this.mapData.name==f.mapName?f.mapName="china":f.mapName=e.params[this.mapData.name]?this.mapData.name:"china"),a.area=this.mapData,a.areaData=f._getDataForArea(this.mapData),a.eventInfo=f._getDataForArea(this.mapData),f.fire("areaclick",a)}),f.area.text.enabled){var l=new a.Display.Text(_.isFunction(f.area.text.filter)?f.area.text.filter(b.name):b.name,{context:{cursor:"pointer",x:b.textX,y:b.textY,fillStyle:f.area.text.fillStyle,textBaseline:"middle",textAlign:"center"}});l.area=k,l.on("mouseover",function(a){a.fromTarget&&a.fromTarget==this.area||this.area.fire("mouseover",a)}),l.on("mousemove",function(a){this.area.fire("mousemove",a)}),l.on("mouseout",function(a){a.toTarget&&a.toTarget==this.area||this.area.fire("mouseout release",a)}),l.on("click",function(a){this.area.fire("click",a)}),d.addChild(l)}}),f.sprite.addChild(i),d&&f.sprite.addChild(d)},_initMarkPoint:function(){var a=this;require(["chartx/chart/map/map-data/geo-json/china_city"],function(b){_.each(a.dataFrame.xAxis.org[0],function(c,d){if(c in a.geoCoordSupply)a._setMarkToPoint(c,a.geo2pos(a.mapName,a.geoCoordSupply[c]));else for(var e in b)if(c in b[e]){var f=a.geo2pos(a.mapName,b[e][c]);a._setMarkToPoint(c,f);break}})})},_setMarkToPoint:function(a,b){var c=this,d={name:a},e={point:{x:b[0],y:b[1]}},f=c._getDataForArea(d);c._opts.markPoint&&c._opts.markPoint.r&&_.isFunction(c._opts.markPoint.r)&&(c._opts.markPoint.r=c._opts.markPoint.r(f)),new k(c._opts,e,f).done(function(){var a=this.shape;a.mapData=d,a.on("mouseover",function(a){c._tips.show(c._setTipsInfoHand(a,this.mapData)),this.context.lineWidth+=2}),a.on("mousemove",function(a){c._tips.move(c._setTipsInfoHand(a,this.mapData))}),a.on("mouseout",function(a){c._tips.hide(),this.context.lineWidth-=2}),a.on("click",function(a){a.areaData=c._getDataForArea(this.mapData),c.fire("markpointclick",a)}),c.sprite.addChild(this.sprite)})},_initModule:function(){this._tips=new i(this.tips,this.canvax.getDomContainer()),this._tips._getDefaultContent=function(a){var b="<table>",c=this;return b+="<tr><td colspan='2'>"+a.area.value+"</td></tr>",_.each(a.nodesInfoList,function(a,d){b+="<tr >";var e=c.prefix[d];e||(e=a.field),b+="<td>"+e+"：</td>",b+="<td>"+a.value+"</td></tr>"}),b+="</table>"},this.spriteTip.addChild(this._tips.sprite)},_setTipsInfoHand:function(a,b){var c={area:{field:this.areaField,value:b.name},nodesInfoList:[]},d=this._getDataForArea(b);return d.data&&_.each(this.tips.field,function(a,b){var e=d.data[a];void 0!==e&&null!==e&&c.nodesInfoList.push({field:a,value:d.data[a]})}),a.tipsInfo=c,a}})});